# Cursor Rules for Todo App

あなたは高度な問題解決能力を持つAIアシスタントです。以下の指示に従って、効率的かつ正確にタスクを遂行してください。

まず、ユーザーから受け取った指示を確認します：
<指示>
{{instructions}}
</指示>

この指示を元に、以下のプロセスに従って作業を進めてください：

## 原則

- 回答はすべて日本語でお願いします（Always respond in Japanese）
- 実際にコードを書き始める前に、先に設計を行い、ユーザに確認するようにしてください
- 設計したタスクをステップごとに1つずつ実行するようにしてください
- 各ステップを完了する前に、必ず test と lint を実行し、エラーがないことを確認してください
- 作業を完了する直前に、今回の変更をドキュメント化し、 `/docs` ディレクトリに保存してください
- 各ステップの完了後に、要点をユーザにレポートするようにしてください
- ステップを実行した結果、 `.cursorrules` の更新ができるようならば、それを提案してください

## 重要な注意事項

- 不明点がある場合は、作業開始前に必ず確認を取ってください。
- 重要な判断が必要な場合は、その都度報告し、承認を得てください。
- 予期せぬ問題が発生した場合は、即座に報告し、対応策を提案してください。
- **明示的に指示されていない変更は行わないでください。** 必要と思われる変更がある場合は、まず提案として報告し、承認を得てから実施してください。
- **勝手に既存の機能を削除しないでください。** 既存の機能を削除する場合は、その理由を明確にして承認を得るまでは変更を行わないでください。
- **技術スタックに記載のバージョン（APIやフレームワーク、ライブラリ等）を勝手に変更しないでください。** 変更が必要な場合は、その理由を明確にして承認を得るまでは変更を行わないでください。
- 設計ドキュメントは、都度 `/docs` ディレクトリに保存してください。
- **テストコードは必ず作成してください。** Vitestを使用し、単体テストと統合テストを適切に実装してください。
- **パッケージ間の依存関係は明確にしてください。** 循環参照を避け、適切な層構造を維持してください。
- **ドキュメントを各ステップ終了時に作成してください。** ドキュメントは `/docs` ディレクトリに保存してください。
- 仮の実装を作成する場合は、それが仮の実装であることをソースコードに明記してください。
- **作業環境を破壊するようなコマンドは実行してはいけません。** `npm install -g` などのコマンドは実行しないでください。どうしても必要であれば、その旨を報告し、承認を得てから実行してください。
- ユーザのカーソル操作が必要なコマンドは発行してはいけません。

## コーディング規約

### 命名規則

- パスカルケース: クラス、インターフェース、型
- キャメルケース: 変数、関数、メソッド
- スネークケース: 定数
- ケバブケース: ファイル名、ディレクトリ名

### ファイル構成

- コンポーネントファイル: `*.tsx`
- フックファイル: `*.hooks.ts`
- ユーティリティファイル: `*.utils.ts`
- テストファイル: `*.test.ts`
- スタイルファイル: `*.module.css`

### コードスタイル

- インデント: 2スペース
- 最大行長: 80文字
- セミコロン: 必須
- クォート: シングルクォート
- コメント: JSDoc形式

## テスト要件

- テストコードは必ず作成してください
- Vitestを使用し、単体テストと統合テストを適切に実装してください
- テストコードのテスト項目名は日本語で記載してください
- テストコードは、テスト対象と同じディレクトリに保存してください
- `__tests__` ディレクトリなどは作成しないでください

### テスト環境の設定

- `@testing-library/jest-dom`は`import '@testing-library/jest-dom'`の形式でインポート
- ブラウザAPIを使用する場合は、適切なモックを`vitest.setup.ts`に実装
  - 例：`window.matchMedia`のモック
- Vitestの設定は最小限に留め、複雑な設定は避ける
  - 例：`pool`や`poolOptions`などの高度な設定は使用しない
- テストの実行時間を定期的に監視し、パフォーマンスの低下があれば対処

## アーキテクチャ要件

### Clean Architecture

- `packages/domain` にドメインロジックを実装する。
- アプリケーションコアはここに実装すること。他のパッケージに依存せずとも動作することを目指す。
  - ドメインモデル（エンティティ、値オブジェクト）
  - ドメインサービス
  - リポジトリインターフェース
  - ユースケース

### バックエンド

- クリーンアーキテクチャを採用
- 依存関係の方向は外から内へ（UI → ユースケース → ドメイン）
- 各レイヤーは独立して実装・テスト可能
- リポジトリパターンによるデータアクセスの抽象化
- トランザクション管理はリポジトリレベルで実施

### フロントエンド

- コンポーネントの責務を明確に分離
  - Container/Component パターンを採用
  - Component は主に `packages/ui` に配置
- データフェッチはReact Queryを使用
- 状態管理はReact Query + Zustandを使用
- パフォーマンス最適化を考慮したコンポーネント設計
- アクセシビリティに配慮したマークアップ

## パッケージ

### @cursor-rules-todoapp/repo-sqlite

- SQLiteリポジトリの実装
- Prismaクライアント
- データマッパー

### @cursor-rules-todoapp/repo-postgres（将来的）

- PostgreSQLリポジトリの実装
- Prismaクライアント
- データマッパー

### @cursor-rules-todoapp/common

- 型定義
- 定数
- ユーティリティ関数
- 他のパッケージから参照される共通機能

### @cursor-rules-todoapp/configs

- TypeScript設定
- Tailwind設定
- その他の共通設定

### @cursor-rules-todoapp/ui

- 共通UIコンポーネント
- Shadcn/UIコンポーネント
- スタイル定義
- Storybook
- テスト

### apps/web

- ページ実装
- APIルート
- アプリケーション固有の機能

## ドキュメント要件

- 各機能の設計ドキュメントを作成
- APIドキュメントを作成
- テスト仕様書を作成
- 運用手順書を作成
- すべてのドキュメントは `/docs` ディレクトリに保存
- ドキュメントは日本語で記載

## 技術スタック

### 開発環境

- TypeScript
- Node.js
- Monorepo
- Claude 3.5 Sonnet

### フロントエンドスタック

- React 19
- Next.js App Router
- Tailwind CSS
- Shadcn/UI

### バックエンドスタック

- TRPC
- Zod
- Prisma
- SQLite（開発環境）
- PostgreSQL（将来的な本番環境）

### 開発ツール

- pnpm
- Biome
- TurboRepo
- Vitest
- Storybook 8.5.1

## ファイル構造

```plaintext
root
├── apps                    # アプリケーション
│ ├── web                   # ウェブアプリケーション
│ │ ├── src
│ │ │ ├── app
│ │ │ │ ├── api           # API
│ │ │ │ ├── somePageName  # ページ
│ │ │ │ │ ├── components  # コンポーネント
│ │ │ │ │ ├── hooks      # フック
│ │ │ │ │ ├── page.tsx   # ページ
│ │ │ │ │ └── [id].tsx   # ページ
│ │ │ ├── components      # コンポーネント
│ │ │ ├── hooks          # フック
│ │ │ └── utils          # ユーティリティ
│ └── api                  # APIサーバー
│   ├── src
│   │ ├── router         # tRPCルーター
│   │ ├── container      # DIコンテナ
│   │ ├── middleware     # ミドルウェア
│   │ └── errors         # エラーハンドリング
├── packages               # パッケージ
│ ├── domain              # ドメイン層
│ │ ├── src
│ │ │ ├── entities      # エンティティ
│ │ │ ├── services      # ドメインサービス
│ │ │ ├── repositories  # リポジトリインターフェース
│ │ │ └── usecases      # ユースケース
│ ├── repo-sqlite         # SQLiteリポジトリ
│ │ ├── src
│ │ │ ├── repositories  # リポジトリ実装
│ │ │ └── mappers       # データマッパー
│ ├── ui                  # UI
│ ├── configs             # 各種設定ファイル
│ └── common              # ユーティリティ
├── docs                  # ドキュメント
├── .gitignore            # 無視するファイル
├── .turbo                # TurboRepoの設定
├── pnpm-lock.yaml        # pnpmのロックファイル
├── turbo.json            # TurboRepoの設定
├── tsconfig.json         # TypeScriptの設定
└── README.md             # プロジェクトの説明
```

## Git ワークフロー

### ブランチ命名規則

- 機能追加: `feature/機能名`
- バグ修正: `fix/修正内容`
  - 複数の改善を含む場合: `fix/対象-and-改善内容`
    例：`fix/darkmode-and-filter-improvements`
- リファクタリング: `refactor/変更内容`
- ドキュメント: `docs/ドキュメント内容`
- 設定変更: `config/設定内容`

### プルリクエスト生成前のチェック

1. コード品質チェック

   ```bash
   pnpm fix  # 自動修正を含む包括的なチェック
   ```

   - `biome:check:write`: コードの自動フォーマットと修正
   - `typecheck`: 型チェック

2. テストの実行

   ```bash
   pnpm test        # ユニットテスト
   ```

3. CIチェックの実行（オプション）

   ```bash
   pnpm check:ci  # CI環境と同じチェックを実行
   ```

### エラー対応手順

1. エラーの種類を特定

   ```bash
   # CIの実行結果の確認
   gh run list --limit 1                     # 最新のCI実行結果を確認
   gh run view {id}                         # 特定のCI実行の詳細を確認
   gh run view --log-failed --job={job_id}  # 失敗したジョブのログを確認
   ```

2. エラーの修正
   - 型エラー、リントエラー、テストエラーなど、エラーの種類に応じて対応
   - 修正後は必ず `pnpm fix` を実行して、新たな問題が発生していないことを確認

3. プッシュ前の最終確認

   ```bash
   pnpm fix  # 必ず実行
   git add .
   git commit -m "fix: エラーの修正内容"
   git push
   ```

### レビュープロセス

1. レビューコメントの確認

   ```bash
   gh pr list                                # PRの一覧を確認
   gh pr view {pr_number}                    # PRの詳細を確認
   gh pr checks {pr_number}                  # CIの結果を確認
   gh pr comments {pr_number}                # レビューコメントを確認
   ```

2. レビューコメントへの対応
   - 指摘された箇所を修正
   - 修正後は必ず `pnpm fix` を実行
   - 修正内容をコミット前に確認

   ```bash
   git diff  # 変更内容の確認
   pnpm fix  # 必ず実行
   ```

3. レビュー完了条件
   - すべてのレビューコメントに対応完了
   - `pnpm fix` が正常終了
   - CIが成功
   - レビュアーからLGTMを取得

### 注意事項

1. 自動修正の確認
   - `pnpm fix` による自動修正後は、変更内容を必ず確認
   - 意図しない修正が含まれていないことを確認

2. コミット前のチェック
   - 必ず `pnpm fix` を実行してからコミット
   - 新たな問題が発生していないことを確認

3. プッシュ前の確認
   - 最後に必ず `pnpm fix` を実行
   - すべてのチェックが通過することを確認

4. CI環境との整合性
   - ローカルで `pnpm check:ci` を実行して、CI環境と同じ条件でチェック可能
   - CI失敗時は、同じコマンドでローカルで再現して確認

### マージ後の後処理手順

1. プルリクエストをマージする

   ```bash
   gh pr merge <PR番号> --merge --delete-branch
   ```

2. mainブランチを最新に更新する

   ```bash
   git pull origin main
   ```

### GitHub Issue作成のルール

- Issue作成時は必ず `$'...'` 形式を使用してください

  ```bash
  gh issue create --title "タイトル" --body $'## 概要\n\n内容...' --label "ラベル"
  ```

- これは、Markdownの見出しレベルを正しく表示するために必要です
- 見出しは以下の階層構造を基本とします：
  - h2（`##`）: 主要セクション（概要、現状の問題点、改善内容など）
  - h3（`###`）: サブセクション（詳細な分類、具体的な改善項目など）
  - h4（`####`）: サブサブセクション（さらに詳細な分類、具体的な改善項目など）

# UIテストのルール

## 環境依存の排除

- ✅ 固定の日付を使用する
  ```typescript
  const baseDate = new Date('2024-03-01');
  ```
- ❌ 実行時の日付を使用しない
  ```typescript
  const date = new Date();
  ```

## テストの構造化

- ✅ Arrange-Act-Assert-Cleanup パターンに従う
- ✅ 各セクションにコメントを付ける
- ✅ 環境設定は必ずクリーンアップする

## モックの使用

- ✅ 必要最小限のモックのみ使用
- ✅ 環境依存の部分のみモック
- ❌ 実装の詳細に依存するモックを作成しない

## テスト名

- ✅ 日本語で記述
- ✅ 期待される動作を明確に
- ✅ 条件と結果を含める

## アサーション

- ✅ ユーザーから見える結果を検証
- ✅ 実装の詳細ではなく、動作を検証
- ❌ 内部状態への依存を避ける
