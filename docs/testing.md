# テストガイド

## テストの実行

```bash
# すべてのテストを実行
pnpm test

# 特定のパッケージのテストを実行
pnpm test --filter @cursor-rules-todoapp/repo-sqlite

# ウォッチモードでテストを実行
pnpm test --watch
```

各テストは独自のデータベースファイルを使用し、テストライフサイクルで自動的に管理されます：

1. テスト開始時にテンプレートDBが作成される
2. 各テストケースで一意のテストDBが作成される
3. テスト終了時にすべてのDBファイルが自動的に削除される

これにより、テストの独立性が保たれ、パラレル実行が可能になります。

## テストの構造

### ディレクトリ構造

```
packages/
  └── {package-name}/
      └── src/
          ├── components/
          │   └── {component}/
          │       ├── {component}.tsx
          │       └── {component}.test.tsx
          ├── repositories/
          │   ├── {repository}.ts
          │   └── {repository}.test.ts
          └── usecases/
              ├── {usecase}.ts
              └── {usecase}.test.ts
```

- テストファイルは実装ファイルと同じディレクトリに配置
- テストファイルの命名規則: `{target}.test.ts(x)`

### データベーステスト

#### テストデータベースの仕組み

1. **テンプレートDB**
   - テスト開始時に作成される基準となるDB
   - `template.db` として作成
   - テスト終了時に自動的に削除

2. **テストDB**
   - 各テストケースで使用する一時的なDB
   - `test-{uuid}.db` として作成
   - テストケース終了時に自動的に削除

#### テストライフサイクル

```typescript
beforeAll(() => {
  // テンプレートDBの作成
});

afterAll(() => {
  // テンプレートDBの削除
});

beforeEach(() => {
  // テストDBの作成
  // テンプレートDBからコピー
  // Prismaクライアントの初期化
});

afterEach(() => {
  // Prisma接続の切断
  // テストDBの削除
});
```

## テスト作成のガイドライン

1. **テストケースの記述**
   - テストケース名は日本語で記述
   - 期待される動作を明確に説明
   - 例: `it('新しいTodoを作成できる', ...)`

2. **データベーステスト**
   - 各テストは独立した環境で実行
   - テストデータは明示的に作成
   - トランザクションのテストも考慮

3. **エラーケースのテスト**
   - 正常系だけでなく異常系もテスト
   - エラーメッセージの検証も実施

4. **非同期処理のテスト**
   - `async/await` を適切に使用
   - Promiseの解決を待つ

## 環境変数

- テスト用の環境変数は `.env.test` に定義
- データベースURLは自動的に設定
- 必要に応じて追加の環境変数を定義可能

## CI/CD

- GitHub Actionsでテストを自動実行
- プルリクエスト時にテストが実行される
- テストが失敗した場合はマージ不可 