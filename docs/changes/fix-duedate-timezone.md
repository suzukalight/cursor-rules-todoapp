# 期限日のタイムゾーン問題の修正

## 概要

TodoItemコンポーネントにおいて、期限日の入力時にタイムゾーンの影響で日付がずれる問題が発生していました。
この問題を解決するため、日付の処理方法を改善しました。

## 問題の詳細

### 発生していた問題

1. ユーザーが `2025-06-30` を選択すると：
   - コンポーネントには `2025-06-29` と表示
   - blur時に `2025-06-28` として保存

2. 原因
   - 日付オブジェクトの作成時にタイムゾーンの変換が複数回発生
   - `toISOString()` による UTC 変換時に日付がずれる
   - ローカルタイムゾーン（日本時間）とUTCの間で日付が不適切に変換される

### 技術的な詳細

```typescript
// 修正前：複数回のタイムゾーン変換が発生
const date = new Date(`${newValue}T00:00:00Z`);  // UTC日付として解釈
const localDate = new Date(...);                  // ローカルタイムに変換
date.toISOString();                              // 再度UTCに変換
```

## 修正内容

### 実装の変更点

1. 日付オブジェクトの作成
   ```typescript
   // YYYY-MM-DD形式の文字列から日付を作成
   const [year, month, day] = newValue.split('-').map(Number);
   const localDate = new Date(year, month - 1, day);
   localDate.setHours(0, 0, 0, 0);
   ```

2. UTC日付の作成
   ```typescript
   // UTCの同じ日付を作成
   const utcDate = new Date(Date.UTC(year, month - 1, day));
   ```

3. 表示用フォーマットの改善
   ```typescript
   const displayDate = date 
     ? format(date, 'yyyy-MM-dd', { locale: ja }) 
     : '';
   ```

### 改善点

1. 日付の一貫性
   - 選択した日付が処理全体を通じて同じ値を維持
   - タイムゾーンの変換による意図しない日付の変更を防止

2. 直感的な動作
   - ユーザーが選択した日付がそのまま表示・保存される
   - ブラウザネイティブのカレンダーUIを使用可能

3. 堅牢性
   - タイムゾーンに依存しない日付処理
   - 日付の妥当性チェックの簡素化

## 技術的な解説

1. 日付処理の基本方針
   - ローカルタイムゾーンでの日付作成を基本とする
   - 必要な場合のみUTC変換を行う
   - 複数回の変換を避ける

2. タイムゾーン処理
   - `Date.UTC()` を使用して直接UTCの日付を作成
   - ローカルタイムとUTC間の変換を最小限に抑える

3. 日付フォーマット
   - `date-fns` の `format` 関数を使用
   - 日本語ロケールを適用
   - YYYY-MM-DD形式で一貫性を保持

## 影響範囲

1. 修正の影響を受けるコンポーネント
   - `TodoItem` コンポーネント
   - 期限日の入力機能を持つ関連コンポーネント

2. データの整合性
   - 既存のデータには影響なし
   - 新規入力される日付のみが対象

## テスト項目

1. 基本機能
   - [ ] 日付選択が正しく機能する
   - [ ] 選択した日付が正しく表示される
   - [ ] blur後も日付が維持される

2. エッジケース
   - [ ] 月末日の選択（31日など）
   - [ ] 月をまたぐ日付の選択
   - [ ] タイムゾーン境界での日付選択

## 今後の課題

1. パフォーマンス最適化
   - 日付処理の効率化
   - 不要な再レンダリングの防止

2. ユーザビリティ向上
   - カレンダーUIのカスタマイズ
   - キーボード操作のサポート強化

## 参考情報

- [Date.UTC() - MDN](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Date/UTC)
- [date-fns ドキュメント](https://date-fns.org/) 